---
import BaseLayout from "../layouts/BaseLayout.astro";
import NewsCard from "../components/NewsCard.astro";
import Pagination from "../components/Pagination.astro";
import {
  classifyTopics,
  loadNews,
  classifyEventType,
  EVENT_LABELS,
  getLatestBySource,
  getLatestByTopic,
  getNewsPage,
  TOPIC_LABELS,
} from "../lib/news";

const { items, totalPages, currentPage, totalItems } = getNewsPage(1);
const allItems = loadNews();
const todayKey = new Date().toISOString().slice(0, 10);
const todayItems = allItems.filter((item) => String(item.published_at || "").slice(0, 10) === todayKey);
const todayCounts: Record<string, number> = {};
for (const key of Object.keys(EVENT_LABELS)) {
  todayCounts[key] = 0;
}
for (const item of todayItems) {
  const kind = classifyEventType(item);
  todayCounts[kind] = (todayCounts[kind] ?? 0) + 1;
}

const activeSources = getLatestBySource(1).slice(0, 10);
const activeTopics = getLatestByTopic(1).slice(0, 8);
const baseUrl = import.meta.env.BASE_URL;
const normalizedBaseUrl = baseUrl.endsWith("/") ? baseUrl : `${baseUrl}/`;
const withBase = (path) => `${normalizedBaseUrl}${String(path ?? "").replace(/^\/+/, "")}`;
---
<BaseLayout title="Latest" description="Latest official policy and macro updates">
  <section class="glass-panel rounded-3xl px-4 py-4 shadow-soft sm:px-6 sm:py-6">
    <div class="flex flex-wrap items-end justify-between gap-4">
      <div>
        <h2 class="page-title text-xl font-semibold text-ink-950 sm:text-2xl">Latest</h2>
      </div>
      <div class="text-xs text-ink-900/70 sm:text-sm">Total {totalItems} items</div>
    </div>

    <div class="mt-4 rounded-2xl border border-ink-900/10 bg-white/60 px-4 py-3">
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-xs text-ink-900/70">
          <span class="font-medium text-ink-950">Today</span>
          <span>{todayItems.length} new</span>
          <span class="hidden sm:inline">Build-day snapshot</span>
        </div>
        <div class="flex flex-wrap items-center gap-2 text-[11px] text-ink-900/60">
          {Object.entries(EVENT_LABELS)
            .filter(([key]) => (todayCounts[key] ?? 0) > 0)
            .map(([key, label]) => (
              <span class="rounded bg-ink-900/10 px-2 py-1">
                {label} {todayCounts[key]}
              </span>
            ))}
        </div>
      </div>
    </div>
    <div class="mt-5 grid gap-4 sm:mt-6 sm:gap-6 lg:grid-cols-12">
      <div class="lg:col-span-8">
        {totalPages > 1 && <Pagination current={currentPage} total={totalPages} />}
        {items.length === 0 ? (
          <div class="mt-6 rounded-2xl border border-dashed border-ink-900/20 px-6 py-12 text-center text-sm text-ink-900/60">
            No data yet. Enable sources in crawler/sources_config.yaml and run the crawler.
          </div>
        ) : (
          <div class="mt-4">
            {items.map((item) => (
              <NewsCard
                item={item}
                density="compact"
                topics={classifyTopics(item).map((t) => TOPIC_LABELS[t])}
                eventTypeLabel={EVENT_LABELS[classifyEventType(item)]}
              />
            ))}
          </div>
        )}
        {totalPages > 1 && <Pagination current={currentPage} total={totalPages} />}
      </div>

      <aside class="lg:col-span-4 space-y-4 sm:space-y-6">
        {activeTopics.length > 0 && (
          <div class="rounded-2xl border border-ink-900/10 bg-white/60 px-4 py-3 sm:px-5 sm:py-4">
            <div class="flex items-end justify-between gap-3">
              <div class="text-sm font-medium text-ink-950">Topics pulse</div>
              <a href={withBase("topics/")} class="text-xs text-ink-900/60 hover:text-ink-950">
                All
              </a>
            </div>
            <ul class="mt-2.5 divide-y divide-ink-900/10 sm:mt-3">
              {activeTopics.map((group) => {
                const item = group.items[0];
                const ts = item?.published_at ? String(item.published_at).slice(5, 16).replace("T", " ") : "";
                return (
                  <li class="py-2">
                    <div class="flex items-baseline justify-between gap-3">
                      <a
                        href={withBase(`topic/${group.id}/`)}
                        class="min-w-0 flex-1 truncate text-sm text-ink-950 hover:text-accent-600"
                      >
                        {group.label}
                      </a>
                      <span class="shrink-0 text-[11px] text-ink-900/60 tabular-nums">{ts}</span>
                    </div>
                    {item?.title && (
                      <a
                        href={item.url}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="mt-1 block text-[11px] text-ink-900/60 hover:text-accent-600 line-clamp-1"
                      >
                        {item.title}
                      </a>
                    )}
                  </li>
                );
              })}
            </ul>
          </div>
        )}

        {activeSources.length > 0 && (
          <div class="rounded-2xl border border-ink-900/10 bg-white/60 px-4 py-3 sm:px-5 sm:py-4">
            <div class="flex items-end justify-between gap-3">
              <div class="text-sm font-medium text-ink-950">Active sources</div>
              <a href={withBase("sources/")} class="text-xs text-ink-900/60 hover:text-ink-950">
                All
              </a>
            </div>
            <ul class="mt-2.5 divide-y divide-ink-900/10 sm:mt-3">
              {activeSources.map((group) => {
                const item = group.items[0];
                const kind = item ? EVENT_LABELS[classifyEventType(item)] : "";
                const ts = item?.published_at ? String(item.published_at).slice(5, 16).replace("T", " ") : "";
                return (
                  <li class="py-2">
                    <div class="flex items-baseline justify-between gap-3">
                      <a
                        href={withBase(`source/${group.id}/`)}
                        class="min-w-0 flex-1 truncate text-sm text-ink-950 hover:text-accent-600"
                      >
                        {group.name}
                      </a>
                      <span class="shrink-0 text-[11px] text-ink-900/60 tabular-nums">{ts}</span>
                    </div>
                    {kind && (
                      <div class="mt-1 text-[11px] text-ink-900/60">
                        <span class="rounded bg-ink-900/10 px-1.5 py-0.5">{kind}</span>
                      </div>
                    )}
                  </li>
                );
              })}
            </ul>
          </div>
        )}
      </aside>
    </div>
  </section>
</BaseLayout>
