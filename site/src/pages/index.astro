---
import BaseLayout from "../layouts/BaseLayout.astro";
import NewsCard from "../components/NewsCard.astro";
import Pagination from "../components/Pagination.astro";
import {
  classifyTopics,
  classifyEventType,
  EVENT_LABELS,
  getLatestBySource,
  getLatestByTopic,
  getNewsPage,
  TOPIC_LABELS,
} from "../lib/news";

const { items, totalPages, currentPage, totalItems } = getNewsPage(1);
const bySource = getLatestBySource(6);
const byTopic = getLatestByTopic(10);
const baseUrl = import.meta.env.BASE_URL;
const normalizedBaseUrl = baseUrl.endsWith("/") ? baseUrl : `${baseUrl}/`;
const withBase = (path) => `${normalizedBaseUrl}${String(path ?? "").replace(/^\/+/, "")}`;
---
<BaseLayout title="Latest" description="Latest official policy and macro updates">
  <section class="glass-panel rounded-3xl px-6 py-8 shadow-soft">
    <div class="flex flex-wrap items-end justify-between gap-4">
      <div>
        <p class="text-xs uppercase tracking-[0.35em] text-ink-900/60">PolicyPulse</p>
        <h2 class="mt-2 text-3xl font-semibold text-ink-950">Latest Stream</h2>
      </div>
      <div class="text-sm text-ink-900/70">Total {totalItems} items</div>
    </div>

    {bySource.length > 0 && (
      <div class="mt-6 rounded-2xl border border-ink-900/10 bg-white/60 px-5 py-4">
        <div class="flex flex-wrap items-end justify-between gap-3">
          <div class="text-sm font-medium text-ink-950">By source</div>
          <a href={withBase("sources/")} class="text-xs text-ink-900/60 hover:text-ink-950">
            View all sources
          </a>
        </div>
        <div class="mt-4 grid gap-4 md:grid-cols-2">
          {bySource.map((group) => (
            <div class="rounded-2xl border border-ink-900/10 bg-white/70 px-4 py-3">
              <div class="flex items-center justify-between gap-3">
                <a
                  href={withBase(`source/${group.id}/`)}
                  class="text-sm font-medium text-ink-950 hover:text-accent-600"
                >
                  {group.name}
                </a>
                <span class="text-xs text-ink-900/60">Latest {group.items.length}</span>
              </div>
              <ul class="mt-3 space-y-2">
                {group.items.map((item) => (
                  <li class="text-xs text-ink-900/70">
                    <a
                      href={item.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="hover:text-accent-600"
                    >
                      <span class="mr-2 rounded bg-ink-900/10 px-1.5 py-0.5 text-[10px] text-ink-900/70">
                        {EVENT_LABELS[classifyEventType(item)]}
                      </span>
                      {item.title}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          ))}
        </div>
      </div>
    )}

    {byTopic.length > 0 && (
      <div class="mt-6 rounded-2xl border border-ink-900/10 bg-white/60 px-5 py-4">
        <div class="flex flex-wrap items-end justify-between gap-3">
          <div class="text-sm font-medium text-ink-950">By topic</div>
          <div class="text-xs text-ink-900/60">Generalist view</div>
        </div>
        <div class="mt-4 grid gap-4 md:grid-cols-2">
          {byTopic.map((group) => (
            <div class="rounded-2xl border border-ink-900/10 bg-white/70 px-4 py-3">
              <div class="flex items-center justify-between gap-3">
                <div class="text-sm font-medium text-ink-950">{group.label}</div>
                <span class="text-xs text-ink-900/60">Latest {group.items.length}</span>
              </div>
              <ul class="mt-3 space-y-2">
                {group.items.map((item) => (
                  <li class="text-xs text-ink-900/70">
                    <a
                      href={item.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="hover:text-accent-600"
                    >
                      <span class="mr-2 rounded bg-ink-900/10 px-1.5 py-0.5 text-[10px] text-ink-900/70">
                        {EVENT_LABELS[classifyEventType(item)]}
                      </span>
                      {item.title}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          ))}
        </div>
      </div>
    )}
    {items.length === 0 ? (
      <div class="mt-8 rounded-2xl border border-dashed border-ink-900/20 px-6 py-12 text-center text-sm text-ink-900/60">
        No data yet. Enable sources in crawler/sources_config.yaml and run the crawler.
      </div>
    ) : (
      <div class="mt-6">
        {items.map((item) => (
          <NewsCard
            item={item}
            density="compact"
            topics={classifyTopics(item).map((t) => TOPIC_LABELS[t])}
            eventTypeLabel={EVENT_LABELS[classifyEventType(item)]}
          />
        ))}
      </div>
    )}
    {totalPages > 1 && <Pagination current={currentPage} total={totalPages} />}
  </section>
</BaseLayout>
